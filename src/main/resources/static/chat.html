<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>叽友圈-社交</title>
    <script type="application/javascript">
        ! function(e, t) {
            var n = t.documentElement,
                d = e.devicePixelRatio || 1;
            function i() {
                var e = n.clientWidth / 3.75;
                n.style.fontSize = e.toFixed(0) + "px"
            }
            if ( function e() {
                t.body ? t.body.style.fontSize = "16px" : t.addEventListener("DOMContentLoaded", e)
            }(), i(), e.addEventListener("resize", i), e.addEventListener("pageshow", function(e) { e.persisted && i() }), d >= 2) { var o = t.createElement("body"),
                a = t.createElement("div");
                a.style.border = ".5px solid transparent", o.appendChild(a), n.appendChild(o), 1 === a.offsetHeight && n.classList.add("hairlines"), n.removeChild(o) } }(window, document)
    </script>
    <link href="css/main.css" type="text/css" media="screen" rel="stylesheet">
    <style type="text/css">
        html {
            height: 100%;
        }
        body {
            background-image: url("img/auction_bg.png");
            background-size: 100% 100%;
            height: 100%;
            width: 100%;
            color: #fff;
            font-family: 黑体;
        }
        .auction-name-div {
            background-image: url("img/auction_bg_1.png");
            background-size: 100% 100%;
            height: 0.6rem;
            display: none;
        }
        .auction-name {
            width: 1.16rem;
            display: block;
            margin: 0 auto;
            position: relative;
            top: 0.15rem;
        }
        .chat-padding {
            height: 0.6rem;
            display: none;
        }
        .chat-friends {
            width: 0.74rem;
            display: inline-block;
            height: 100%;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
        }
        .chat-friend {
            height: 0.9rem;
            width: 100%;
            padding-top: 0.07rem;
            background-image: url("img/chat_friend_bg.png");
            background-size: 100% 100%;
            position: relative;
        }
        .chat-friend-selected {
            background-image: url("img/chat_friend_bg_selected.png");
        }
        .chat-friend-btn {
            width: 0.66rem;
            position: fixed;
            bottom: 0.06rem;
            left: 0.03rem;
        }
        .chat-friend-read {
            width: 0.12rem;
            height: 0.12rem;
            background-color: rgb(219, 0, 22);
            border-radius: 0.06rem;
            position: absolute;
            z-index: 1;
            left: 0.1rem;
            top: 0.1rem;
        }
        .chat-friend-head {
            width: 0.58rem;
            height: 0.58rem;
            margin: 0 auto;
        }
        .chat-friend-name {
            font-size: 0.11rem;
            height: 0.24rem;
            line-height: 0.24rem;
        }
        .chat-content {
            width: 3rem;
            height: 100%;
            background-image: url("img/chat_content_bg.png");
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: 0 0.35rem;
            position: absolute;
            top: 0;
            right: 0;
            overflow: hidden;
        }
        .chat-content-buttons {
            display: flex;
            justify-content: center;
            height: 0.3rem;
            padding-top: 0.05rem;
            color: rgb(255, 255, 127);
        }
        .chat-content-button1, .chat-content-button2 {
            width: 1rem;
            height: 0.25rem;
            line-height: 0.25rem;
            font-size: 0.14rem;
            text-align: center;
        }
        .chat-content-button1 {
            background-image: url("img/chat_send_egg.png");
            background-size: 100% 100%;
            margin-right: 0.01rem;
        }
        .chat-content-button2 {
            background-image: url("img/chat_send_coin.png");
            background-size: 100% 100%;
            margin-left: 0.01rem;
        }
        .chat-dialog-head {
            width: 0.36rem;
            height: 0.36rem;
            position: absolute;
            top: 0;
        }
        .chat-dialog-head-left {
            left: 0;
        }
        .chat-dialog-head-right {
            right: 0;
        }
        .chat-content-message {
            height: 100%;
            overflow: auto;
        }
        .chat-dialog {
            position: relative;
            margin-bottom: 0.06rem;
        }
        .chat-padding2 {
            height: 1.42rem;
        }
        .chat-dialog-right {
            text-align: right;
        }
        .chat-dialog-triangle {
            height: 0;
            width: 0;
            border-top: 0.05rem solid transparent;
            border-bottom: 0.05rem solid transparent;
            display: inline-block;
            position: absolute;
            top: 0.07rem;
        }
        .chat-dialog-triangle-left {
            border-right: 0.05rem solid rgb(178, 162, 151);
            left: 0.38rem;
        }
        .chat-dialog-triangle-right {
            border-left: 0.05rem solid rgb(180, 169, 111);
            right: 0.38rem;
        }
        .chat-dialog-content {
            display: inline-block;
            width: 1.96rem;
            padding: 0.02rem 0.1rem;
            position: relative;
            top: 0;
            font-size: 0.13rem;
            line-height: 0.18rem;
            min-height: 0.2rem;
            border-radius: 0.04rem;
            text-align: justify;
            word-break: break-all;
        }
        .chat-dialog-time {
            color: rgb(152, 122, 110);
            text-align: center;
            font-size: 0.11rem;
            padding-top: 0.04rem;
            padding-bottom: 0.02rem;
        }
        .chat-dialog-content-em {
            color: rgb(253, 88, 0);
            font-weight: bold;
        }
        .chat-dialog-content-left {
            left: 0.42rem;
            background-color: rgb(178, 162, 151);
        }
        .chat-dialog-content-right {
            left: 0.42rem;
            text-align: justify;
            background-color: rgb(180, 169, 111);
        }
        .chat-enter {
            width: 3rem;
            height: 0.52rem;
            background-color: rgb(89, 54, 46);
            position: fixed;
            right: 0;
            bottom: 0;
        }
        .chat-input {
            width: 1.9rem;
            height: 0.33rem;
            padding: 0 0.05rem;
            background-color: rgb(109, 73, 58);
            border-radius: 0.03rem;
            border-width: 0;
            outline-width: 0;
            position: absolute;
            left: 0.08rem;
            bottom: 0.1rem;
            color: white;
            font-size: 0.14rem;
        }
        .chat-enter-btn {
            width: 0.72rem;
            height: 0.36rem;
            background-image: url("img/chat_enter.png");
            background-size: 100% 100%;
            font-size: 0.16rem;
            line-height: 0.36rem;
            text-align: center;
            position: absolute;
            right: 0.08rem;
            bottom: 0.09rem;
        }
        .friends-dialog-content {
            background-color: rgb(86, 58, 38);
            border-radius: 0.08rem;
            text-align: center;
            padding: 0 0.05rem 0.05rem 0.05rem;
        }
        .friends-dialog-tab-add {
            background-color: rgb(184, 137, 81);
            margin: 0 0.015rem;
        }
        .friends-dialog-tab-apply-negative {
            background-color: rgb(141, 102, 62);
            margin: 0 0.015rem;
        }
        .friends-dialog-tab-img {
            width: 0.75rem;
            height: 0.21rem;
            margin-top: 0.1rem;
        }
        .friends-dialog-tabs {
            display: flex;
            justify-content: center;
            padding-top: 0.06rem;
        }
        .friends-dialog-tab {
            height: 0.4rem;
            width: 0.9rem;
            line-height: 0.4rem;
            border-radius: 0.03rem;
        }
        .friends-dialog-body {
            background-color: rgb(200, 183, 155);
            height: 2.6rem;
            margin-top: 0.04rem;
            position: relative;
            overflow-y: auto;
            padding: 0.06rem 0;
        }
        .friends-dialog-row {
            height: 0.3rem;
            line-height: 0.3rem;
            text-align: left;
            padding-top: 0.08rem;
        }
        .friends-dialog-label {
            width: 0.68rem;
            color: rgb(86, 58, 38);
            font-size: 0.2rem;
            display: inline-block;
            text-align: right;
            height: 100%;
        }
        .friends-dialog-error {
            display: inline-block;
            height: 0.24rem;
            width: 2.24rem;
            padding: 0 0.05rem;
            line-height: 0.24rem;
            vertical-align: top;
            font-size: 0.15rem;
            color: #fe2e1e;
        }
        .friends-dialog-input {
            height: 0.3rem;
            width: 2.24rem;
            padding: 0 0.05rem;
            background-color: rgb(218, 213, 203);
            outline-width: 0;
            line-height: 0.3rem;
            vertical-align: top;
            border: 0.01rem solid rgb(86, 58, 38);
            color: #2e2e2e;
            font-size: 0.15rem;
        }
        .friends-dialog-btn {
            background-color: rgb(224, 72, 47);
            border: 0.02rem solid rgb(179, 55, 34);
            width: 1rem;
            height: 0.35rem;
            border-radius: 0.02rem;
            font-size: 0.18rem;
            line-height: 0.35rem;
            position: absolute;
            bottom: 0.1rem;
            margin-left: 1.13rem;
        }
        .friends-dialog-row2 {
            width: 3.08rem;
            min-height: 0.72rem;
            position: relative;
            background-color: #f0e6d5;
            margin: 0 auto 0.04rem auto;
            text-align: left;
        }
        .friends-dialog-row2-head {
            width: 0.58rem;
            height: 0.58rem;
            top: 0.07rem;
            left: 0.04rem;
            position: absolute;
        }
        .friends-dialog-row2-content {
            height: 100%;
            padding: 0 0.9rem 0 0.68rem;
            font-size: 0.13rem;
        }
        .friends-dialog-row2-content-name {
            font-size: 0.14rem;
            color: #0a0a0a;
            word-break: break-all;
            padding: 0.05rem 0;
        }
        .friends-dialog-row2-content-tip {
            color: #fe2e1e;
            height: 0.18rem;
            line-height: 0.18rem;
        }
        .friends-dialog-row2-content-words {
            color: #2e2e2e;
            /*height: 0.18rem;*/
            line-height: 0.14rem;
        }
        .friends-dialog-row2-btn {
            width: 0.85rem;
            height: 0.72rem;
            position: absolute;
            right: 0;
            top: 0;
            display: flex;
            justify-content: space-evenly;
            flex-direction: column;
        }
        .friends-dialog-btn2 {
            background-color: rgb(224, 72, 47);
            border: 0.02rem solid rgb(179, 55, 34);
            width: 0.76rem;
            height: 0.26rem;
            border-radius: 0.02rem;
            font-size: 0.18rem;
            line-height: 0.26rem;
            /*margin: 0.03rem;*/
            text-align: center;
        }
        .friends-dialog-btn2-gray {
            background-color: #878787;
            border: 0.02rem solid #6d6d6d;
        }
        .message-dialog-content {
            background-color: rgb(86, 58, 38);
            border-radius: 0.08rem;
            text-align: center;
            padding: 0 0.05rem 0.05rem 0.05rem;
        }
        .message-dialog-title {
            height: 0.5rem;
            line-height: 0.5rem;
            font-size: 0.22rem;
            color: #ffe168;
        }
        .message-dialog-title-img {
            height: 0.36rem;
            vertical-align: middle;
        }
        .message-dialog-body {
            background-color: rgb(200, 183, 155);
            height: 1.2rem;
            margin-top: 0.04rem;
            position: relative;
            overflow-y: auto;
            padding: 0.06rem 0;
        }
        .message-dialog-body-message {
            color: #563a26;
            font-size: 0.2rem;
            height: 0.7rem;
            line-height: 0.7rem;
        }
        .dialog-close2 {
            top: 0.05rem;
        }
        .dialog-order-on-eggs {
            height: 0.71rem;
            width: 100%;
            overflow-x: auto;
            margin: 0.04rem auto 0 auto;
            text-align: center;
            background-color: #e2d7c9;
        }
        .dialog-order-on-eggs-body {
            width: max-content;
            overflow: hidden;
        }
        .dialog-order-on-egg {
            width: 0.54rem;
            height: 0.54rem;
            display: inline-block;
            margin: 0.07rem;
            background-image: url("img/egg.png");
            background-size: 0.33rem 0.44rem;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #9f8660;
        }
        .dialog-order-on-egg-selected {
            background-color: #cb5835;
        }
        .dialog-order-on-egg-name {
            color: #563A26;
            font-size: 0.14rem;
            height: 0.3rem;
            line-height: 0.3rem;
        }
        .eggs-dialog-body {
            background-color: rgb(200, 183, 155);
            height: 2.4rem;
            margin-top: 0.04rem;
            position: relative;
            padding: 0.06rem 0;
        }
        .coins-dialog-body {
            height: 1rem;
        }
        .eggs-dialog-row {
            height: 0.3rem;
            line-height: 0.3rem;
            background-color: #e3d8ca;
            font-size: 0.18rem;
            color: #1b1b1b;
            text-align: left;
            padding-left: 0.44rem;
            margin-top: 0.1rem;
        }
        .eggs-dialog-row-name {
            color: #953535;
        }
        .eggs-dialog-row-num {
            height: 0.24rem;
            width: 0.6rem;
            padding: 0 0.05rem;
            background-color: #5b9b4c;
            outline-width: 0;
            line-height: 0.24rem;
            vertical-align: top;
            border: 0.01rem solid #9ce59a;
            color: #fffd32;
            font-size: 0.15rem;
            margin-top: 0.02rem;
        }
        .eggs-dialog-row-amount {
            font-size: 0.15rem;
        }
    </style>
    <script src="js/angular.js"></script>
</head>
<body ng-app="myApp" ng-init="initAll()" ng-controller="myCtrl" ng-class="{'show': showBody}" class="">
    <div class="auction-name-div">
        <img src="img/chat_name.png" class="auction-name">
    </div>
    <div class="chat-friends">
        <div class="chat-padding"></div>
        <div ng-repeat="item in friends" class="chat-friend hide" ng-class="{'chat-friend-selected': friend == item, 'show': friends}" ng-click="selectFriend(item)">
            <div class="chat-friend-read" ng-show="item.unRead"></div>
            <img class="chat-friend-head" src="img/chat_head.png">
            <div class="chat-friend-name">{{item.userName}}</div>
        </div>
        <img src="img/chat_friend_btn.png" ng-click="openFriendsDialog()" class="chat-friend-btn">
    </div>
    <div class="chat-content" >
        <div class="chat-padding"></div>
        <div class="chat-content-buttons">
            <div class="chat-content-button1 hide" ng-class="{'show': friend}" ng-click="openEggsDialog()">送鸡蛋</div>
            <div class="chat-content-button2 hide" ng-class="{'show': friend}" ng-click="openCoinsDialog()">送金币</div>
        </div>
        <div class="chat-content-message" id="message-content">
            <div class="chat-dialog" ng-repeat="item in messages" repeat-finish>
                <img class="chat-dialog-head" src="img/chat_head.png" ng-show="item.msgType == 1" ng-class="{'chat-dialog-head-left': item.to == myself, 'chat-dialog-head-right': item.from == myself}">
                <div class="chat-dialog-triangle" ng-show="item.msgType == 1" ng-class="{'chat-dialog-triangle-left': item.to == myself, 'chat-dialog-triangle-right': item.from == myself}"></div>
                <div class="chat-dialog-content" ng-class="{'chat-dialog-content-left': item.to == myself, 'chat-dialog-content-right': item.from == myself}">
                    <span ng-class="{'chat-dialog-content-em': item.msgType == 2}">{{item.content}}</span>
                </div>
                <div class="chat-dialog-time">{{timeFormat(item.createTime)}}</div>
            </div>
            <div class="chat-padding2"></div>
        </div>

    </div>
    <div class="chat-enter" ng-show="friend">
        <input class="chat-input" ng-model="messageInput">
        <div class="chat-enter-btn" ng-click="sendMessage()">发送</div>
    </div>
    <div ng-show="showFriends" ng-class="{'hide': !showFriends}" class="hide">
        <mask class="mask" style="z-index: 2;"></mask>
        <div class="dialog" style="z-index: 3;">
            <img class="dialog-close dialog-close2" src="img/dialog_close.png" style="z-index: 4;" ng-click="closeFriendsDialog()">
            <div class="dialog-div">
                <div class="friends-dialog-content">
                    <div class="friends-dialog-tabs">
                        <div class="friends-dialog-tab"
                             ng-class="{'friends-dialog-tab-add': tabIndex == 0, 'friends-dialog-tab-apply-negative': tabIndex == 1}" ng-click="switchFriendsTab(0)">
                            <img class="friends-dialog-tab-img" ng-src="{{ tabIndex == 0 ? 'img/chat_add_friend.png':'img/chat_add_friend_negative.png'}}">
                        </div>
                        <div class="friends-dialog-tab"
                             ng-class="{'friends-dialog-tab-add': tabIndex == 1, 'friends-dialog-tab-apply-negative': tabIndex == 0}" ng-click="switchFriendsTab(1)">
                            <img class="friends-dialog-tab-img" ng-src="{{ tabIndex == 1 ? 'img/chat_apply_friend.png' : 'img/chat_apply_friend_negative.png'}}">
                        </div>
                    </div>
                    <div class="friends-dialog-body" ng-show="tabIndex == 0">
                        <div class="friends-dialog-row">
                            <div class="friends-dialog-label">叽友名</div>
                            <input class="friends-dialog-input" ng-model="friendName">
                        </div>
                        <div class="friends-dialog-row">
                            <div class="friends-dialog-label">附言</div>
                            <input class="friends-dialog-input" ng-model="friendPs">
                        </div>
                        <div class="friends-dialog-row">
                            <div class="friends-dialog-label"></div>
                            <div class="friends-dialog-error hide" ng-show="friendNotFound">{{friendNotFound}}</div>
                        </div>
                        <div class="friends-dialog-btn" ng-click="addFriend()" ng-class="{'gray': !canAddFriend()}">
                            添加
                        </div>
                    </div>
                    <div class="friends-dialog-body" ng-show="tabIndex == 1">
                        <div ng-if="applies && applies.length == 0">
                            暂无申请
                        </div>
                        <div class="friends-dialog-row2" ng-repeat="item in applies">
                            <img class="friends-dialog-row2-head" src="img/chat_head.png">
                            <div class="friends-dialog-row2-content">
                                <div class="friends-dialog-row2-content-name">{{item.userName}}</div>
                                <div class="friends-dialog-row2-content-tip">申请添加好友</div>
                                <div class="friends-dialog-row2-content-words">附言：<span>{{item.ps}}</span></div>
                            </div>
                            <div class="friends-dialog-row2-btn">
                                <div class="friends-dialog-btn2" ng-click="postApply(1, item.friendId)">
                                    同意
                                </div>
                                <div class="friends-dialog-btn2 friends-dialog-btn2-gray" ng-click="postApply(2, item.friendId)">
                                    忽略
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div ng-show="showMessage" ng-class="{'hide': !showMessage}" class="hide">
        <mask class="mask" style="z-index: 11;"></mask>
        <div class="dialog" style="z-index: 12;">
            <img class="dialog-close dialog-close2" src="img/dialog_close.png" style="z-index: 13;" ng-click="closeMessageDialog()">
            <div class="message-dialog-content">
                <div class="message-dialog-title">
                    <img class="message-dialog-title-img" src="img/message_notification.png">
                </div>
                <div class="message-dialog-body">
                    <div class="message-dialog-body-message">
                        {{info}}
                    </div>
                    <div class="friends-dialog-btn" ng-click="closeMessageDialog()">
                        确定
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div ng-show="showEggs" ng-class="{'hide': !showEggs}" class="hide">
        <mask class="mask" style="z-index: 2;"></mask>
        <div class="dialog" style="z-index: 3;">
            <img class="dialog-close dialog-close2" src="img/dialog_close.png" style="z-index: 4;" ng-click="closeEggsDialog()">
            <div class="message-dialog-content">
                <div class="message-dialog-title">
                    赠送鸡蛋给{{friend.userName}}
                </div>
                <div class="eggs-dialog-body">
                    <div class="dialog-order-on-eggs">
                        <div class="dialog-order-on-eggs-body">
                            <div class="dialog-order-on-egg" ng-repeat="item in eggs" ng-click="selectEgg(item)" ng-class="{'dialog-order-on-egg-selected': item==egg}">
                            </div>
                        </div>
                    </div>
                    <div class="dialog-order-on-egg-name">
                        <span ng-show="egg">{{egg.eggName}}，剩余{{egg.amount - egg.freeze}}个</span>
                    </div>
                    <div class="eggs-dialog-row">
                        鸡蛋名称：<span class="eggs-dialog-row-name">{{egg.eggName}}</span>
                    </div>
                    <div class="eggs-dialog-row">
                        赠送数量：<input class="eggs-dialog-row-num" type="number" ng-model="eggNumber">
                    </div>
                    <div class="friends-dialog-btn" ng-class="{'friends-dialog-btn2-gray': !canSendEgg()}" ng-click="sendEgg()">
                        赠送
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div ng-show="showCoins" ng-class="{'hide': !showCoins}" class="hide">
        <mask class="mask" style="z-index: 2;"></mask>
        <div class="dialog" style="z-index: 3;">
            <img class="dialog-close dialog-close2" src="img/dialog_close.png" style="z-index: 4;" ng-click="closeCoinsDialog()">
            <div class="message-dialog-content">
                <div class="message-dialog-title">
                    赠送金币给{{friend.userName}}
                </div>
                <div class="eggs-dialog-body coins-dialog-body">
                    <div class="eggs-dialog-row">
                        赠送数量：<input class="eggs-dialog-row-num" type="number" ng-model="coinNumber">
                        <span class="eggs-dialog-row-amount">最多{{coinsAmount}}</span>
                    </div>
                    <div class="friends-dialog-btn" ng-class="{'friends-dialog-btn2-gray': !canSendCoin()}" ng-click="sendCoin()">
                        赠送
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="application/javascript">
    var app = angular.module('myApp', []);
    addHttpInterceptor(app);

    app.directive('repeatFinish',function($timeout){
        return {
            restrict: 'A',
            link: function(scope,elem,attr){
                //当前循环至最后一个
                if (scope.$last === true) {
                    $timeout(function () {
                        //向父控制器传递事件消息
                        scope.$emit('repeatFinishCallback');
                    });
                }
            }
        }
    });

    app.controller('myCtrl', function($scope, $http, $timeout) {
        $scope.myself = currentAccount();
        $scope.connectWebSocket = function() {
            window.websocket = new WebSocket("ws://39.105.86.90/websocket/" + currentAccount());
            websocket.onopen = function(event){
            }
            websocket.onclose = function(event){
            }
            websocket.onmessage = function(event){
                var m = JSON.parse(event.data);
                if (m.from.startsWith("sys")) {
                    m.from = m.from.substring(3);
                }
                var mFriendId = m.from;
                if (m.from == currentAccount()) {
                    mFriendId = m.to;
                }
                var friend0;
                $scope.friends.forEach(function (item) {
                    if (item.friendId == mFriendId) {
                        friend0 = item;
                    }
                })
                if ($scope.friend) {
                    if (m.from == $scope.friend.friendId || m.to == $scope.friend.friendId) {
                        $timeout(function () {
                            $scope.messages.push(m);
                        })
                    } else {
                        if (friend0) {
                            $scope.friends = $scope.friends.filter(function (f) {
                                return f.friendId != mFriendId;
                            })
                            friend0.unRead = true;
                            $timeout(function () {
                                $scope.friends.unshift(friend0);
                            })
                        }
                    }
                } else {
                    if (friend0) {
                        $scope.selectFriend(friend0);
                    }
                }
            }
            websocket.onerror = function(event){
                window.setTimeout($scope.connectWebSocket, 2000);
            }
            window.onbeforeunload = function(){
                closeWebsocket();
            }
            function closeWebsocket(){
                if(3 != websocket.readyState){
                    websocket.close();
                }else{
                }
            }
        }
        $scope.initAll = function() {
            $scope.connectWebSocket();
            $scope.loadFriends();
        }
        $scope.loadFriends = function() {
            $http.get("/friends/getFriends/" + currentAccount()).then(function (response) {
                $scope.friends = response.data;
            })
        }
        $scope.loadApplies = function() {
            $http.get("/friends/getApply/" + currentAccount()).then(function (response) {
                $scope.applies = response.data;
            })
        }
        $scope.postApply = function(action, friendId) {
            $http.post("/friends/applyFriend", {
                "accountID": currentAccount(),
                "action": action,
                "friendId": friendId
            }).then(function () {
                $scope.myCloseMessage = function() {
                    $scope.showMessage = false;
                }
                $scope.openMessageDialog("操作成功");
                $scope.loadApplies();
                $scope.loadFriends();
            })
        }
        $scope.sendMessage = function() {
            if ($scope.messageInput && $scope.friend) {
                var messageObj = {
                    from: currentAccount(),
                    to: $scope.friend.friendId,
                    msgType: 1,
                    content: $scope.messageInput,
                    createTime: new Date()
                }
                try {
                    window.websocket.send(JSON.stringify(messageObj));
                    $scope.messages.push(messageObj);
                    delete $scope.messageInput;
                } catch (e) {
                    console.log(e);
                    alert("发送失败！")
                }
            }
        }
        $scope.selectFriend = function(item) {
            $scope.friend = item;
            $scope.friendPage = 0;
            item.unRead = false;
            $http.post("/friends/getMessages", {
                "accountID": currentAccount(),
                "friendID": item.friendId,
                "page": $scope.friendPage,
                "size": 1000
            }).then(function (response) {
                $scope.$on('repeatFinishCallback',function(){
                    var _el = document.getElementById('message-content');
                    _el.scrollTop = _el.scrollHeight;
                });
                $scope.messages = response.data;
            });
        }
        $scope.openFriendsDialog = function () {
            $scope.tabIndex = 0;
            $scope.showFriends = true;
        }
        $scope.closeFriendsDialog = function () {
            $scope.showFriends = false;
            delete $scope.friendNotFound;
        }
        $scope.switchFriendsTab = function (index) {
            $scope.tabIndex = index;
            if (index == 1) {
                $scope.loadApplies();
            }
        }
        $scope.closeMessageDialog = function () {
            if ($scope.myCloseMessage) {
                $scope.myCloseMessage();
                delete $scope.myCloseMessage;
                return;
            }
            $scope.showMessage = false;
            $scope.showCoins = false;
            $scope.showEggs = false;
            $scope.showFriends = false;
            delete $scope.friendNotFound;
        }
        $scope.selectEgg = function (egg) {
            $scope.egg = egg;
        }
        $scope.openEggsDialog = function() {
            $http.post("/user/userEggs", {
                "accountID": currentAccount()
            }).then(function (response) {
                $scope.eggs = response.data;
                $scope.eggNumber = 1;
                $scope.egg = $scope.eggs[0];
                $scope.showEggs = true;
            })
        }
        $scope.sendEgg = function() {
            if (!$scope.canSendEgg()) {
                return;
            }
            $http.post("/friends/sendEgg", {
                "accountID": currentAccount(),
                "egg": $scope.eggNumber,
                "feedId": $scope.egg.feedId,
                "friendID": $scope.friend.friendId
            }).then(function () {
                $scope.openMessageDialog("鸡蛋赠送成功");
            })
        }
        $scope.closeEggsDialog = function () {
            $scope.showEggs = false;
        }
        $scope.canSendEgg = function() {
            if (!$scope.eggNumber || !$scope.friend || !$scope.egg) {
                return false;
            }
            return $scope.eggNumber > 0 && $scope.eggNumber <= $scope.egg.amount - $scope.egg.freeze;
        }
        $scope.canSendCoin = function() {
            if (!$scope.coinNumber || !$scope.friend) {
                return false;
            }
            return $scope.coinNumber > 0 && $scope.coinNumber <= $scope.coinsAmount;
        }
        $scope.openCoinsDialog = function() {
            if (!$scope.friend) {
                return;
            }
            $http.post("/user/getCoin", {
                "accountID": currentAccount()
            }).then(function (response) {
                $scope.coinsAmount = response.data.coin;
                $scope.coinNumber = 1;
                $scope.showCoins = true;
            })
        }
        $scope.sendCoin = function() {
            if ($scope.canSendCoin()) {
                $http.post("/friends/sendCoin", {
                    "accountID": currentAccount(),
                    "coin": $scope.coinNumber,
                    "friendID": $scope.friend.friendId
                }).then(function (response) {
                    $scope.openMessageDialog("金币赠送成功");
                })
            }
        }
        $scope.closeCoinsDialog = function () {
            $scope.showCoins = false;
        }
        $scope.timeFormat = function (timeString) {
            var now = new Date();
            var time = new Date(timeString);
            if (time.getFullYear() < now.getFullYear()) {
                return time.getFullYear() + "年" + (time.getMonth() + 1) + "月" + time.getDate() + "日 " + time.getHours() + ":" + time.getMinutes();
            }
            if (time.getDate() == now.getDate()) {
                return time.getHours() + ":" + time.getMinutes();
            }
            return (time.getMonth() + 1) + "月" + time.getDate() + "日 " + time.getHours() + ":" + time.getMinutes();
        }
        $scope.openMessageDialog = function (info) {
            $scope.info = info;
            $scope.showMessage = true;
        }
        $scope.addFriend = function () {
            if (!$scope.canAddFriend()) {
                return;
            }
            $http.post("/friends/addFriend", {
                "accountID": currentAccount(),
                "ps": $scope.friendPs,
                "username": $scope.friendName
            }).then(function () {
                $scope.openMessageDialog("添加好友【" + $scope.friendName + "】申请已发送");
                $scope.loadFriends();
            }, function (response) {
                $scope.friendNotFound = response.data.errors[0];
            })
        }
        $scope.canAddFriend = function () {
            return $scope.friendName && $scope.friendPs;
        }
    });
</script>
</html>